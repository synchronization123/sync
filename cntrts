import requests
import pandas as pd
from datetime import datetime
import os
from openpyxl import load_workbook
from openpyxl.styles import Alignment, Border, Side, Font, PatternFill

# Define variables
contrast_token = 'dhdjdjdjdjrjrjrjdj=='
OrgUUid = 'gshdhdhd'
App_Ids = ['hdj-jdjdjd-7788-jdjdjdj', 'hdjdjdjd', 'dhdjdkdkd']
api_key = 'hhjkkjdddjdkdk'

# Define headers
contrast_headers = {
    'Authorization': contrast_token,
    'Api-key': api_key,
    'Accept': 'application/json'
}

# Base URL for the API
base_url = 'https://contrast.crm.com/Contrast/api/ng/'

# Get current date dynamically (system date: 14-May-25, 04:09 PM IST)
current_date = datetime.now()
date_str = current_date.strftime('%d-%b-%y').upper()  # Format as DD-MMM-YY (e.g., 14-MAY-25)

# Step 1: Fetch data from the API and save to Data.xlsx
all_servers = []
for app_id in App_Ids:
    url = f"{base_url}{OrgUUid}/applications/{app_id}/servers"
    response = requests.get(url, headers=contrast_headers)
    if response.status_code == 200:
        data = response.json()
        servers = data.get('servers', [])
        for server in servers:
            row = {
                'app_id': app_id,
                'environment': server.get('environment', '').upper(),
                'status': server.get('status', ''),
                'server_id': server.get('server_id', ''),
                'name': server.get('name', ''),
                'agent_version': server.get('agent_version', '')
            }
            all_servers.append(row)
    else:
        print(f"Error for App ID {app_id}: {response.status_code} - {response.text}")

# Create DataFrame for raw data and save to Data.xlsx (overwrite daily)
raw_df = pd.DataFrame(all_servers)
raw_df = raw_df[['app_id', 'environment', 'status', 'server_id', 'name', 'agent_version']]
raw_df.to_excel('Data.xlsx', index=False)
print("Raw data successfully saved to Data.xlsx")

# Step 2: Process data for Final.xlsx (aggregate by agent_version and environment)
version_env_counts = {}
for server in all_servers:
    version = server['agent_version']
    env = server['environment']
    if version not in version_env_counts:
        version_env_counts[version] = {'DEVELOPMENT': 0, 'QA': 0}
    if env == 'DEVELOPMENT':
        version_env_counts[version]['DEVELOPMENT'] += 1
    elif env == 'QA':
        version_env_counts[version]['QA'] += 1

# Prepare data for the new columns in Final.xlsx (without date in header initially)
new_data = []
for version, counts in version_env_counts.items():
    total = counts['DEVELOPMENT'] + counts['QA']
    new_data.append({
        'AGENT VERSIONS': version,
        'DEVELOPMENT': counts['DEVELOPMENT'],
        'QA': counts['QA'],
        'TOTAL SERVERS': total
    })

# Create a DataFrame for the new data
new_df = pd.DataFrame(new_data)

# Load existing Final.xlsx if it exists, else create a new DataFrame
excel_file = 'final.xlsx'
existing_dates = []
if os.path.exists(excel_file):
    # Read the existing file, assuming dates are in row 1
    existing_df = pd.read_excel(excel_file, skiprows=1)  # Skip the date row
    # Extract existing dates by inspecting row 1
    with pd.ExcelFile(excel_file) as xls:
        temp_df = pd.read_excel(xls, nrows=0)  # Read headers only
        ws = load_workbook(excel_file).active
        date_row = [cell.value for cell in ws[1] if cell.value]  # Get dates from row 1
        existing_dates = list(dict.fromkeys(date_row))  # Remove duplicates, preserve order
    
    # Remove the TOTAL row if it exists
    if not existing_df.empty and existing_df.iloc[-1]['AGENT VERSIONS'] == 'TOTAL':
        existing_df = existing_df.iloc[:-1]
    
    # Remove current date's columns if they exist
    if date_str in existing_dates:
        date_idx = existing_dates.index(date_str)
        start_col = 1 + date_idx * 3 + 1  # Calculate starting column (e.g., B=2 for first date)
        cols_to_drop = existing_df.columns[start_col-1:start_col+2]  # DEVELOPMENT, QA, TOTAL SERVERS
        existing_df = existing_df.drop(columns=cols_to_drop)
        existing_dates.pop(date_idx)  # Remove the date from the list
    
    # Add the new date to the list (at the end)
    existing_dates.append(date_str)
    
    # Merge with existing DataFrame, ensuring new agent versions have 0 for old dates
    if 'AGENT VERSIONS' in existing_df.columns:
        # Get all unique agent versions
        all_versions = pd.concat([existing_df[['AGENT VERSIONS']], new_df[['AGENT VERSIONS']]], ignore_index=True)
        all_versions = all_versions['AGENT VERSIONS'].drop_duplicates().to_list()
        
        # Reindex both DataFrames to include all agent versions
        existing_df = existing_df.set_index('AGENT VERSIONS').reindex(all_versions).reset_index()
        new_df = new_df.set_index('AGENT VERSIONS').reindex(all_versions).reset_index()
        
        # Fill NaN with 0 for existing_df (old dates, new agent versions)
        existing_df = existing_df.fillna(0)
        for col in existing_df.columns:
            if col != 'AGENT VERSIONS':
                existing_df[col] = existing_df[col].astype(int)
        
        # Merge the DataFrames
        combined_df = existing_df.merge(new_df, on='AGENT VERSIONS', how='outer')
    else:
        combined_df = new_df
else:
    existing_dates = [date_str]
    combined_df = new_df

# Fill NaN values with 0 for numerical columns
combined_df = combined_df.fillna(0)
for col in combined_df.columns:
    if col != 'AGENT VERSIONS':
        combined_df[col] = combined_df[col].astype(int)

# Sort by AGENT VERSIONS
combined_df = combined_df.sort_values('AGENT VERSIONS')

# Add a single TOTAL row at the end
total_row = {'AGENT VERSIONS': 'TOTAL'}
for col in combined_df.columns:
    if col != 'AGENT VERSIONS':
        total_row[col] = combined_df[col].sum()
total_df = pd.DataFrame([total_row])

# Append the TOTAL row
combined_df = pd.concat([combined_df, total_df], ignore_index=True)

# Flatten the DataFrame by repeating the headers for each date
flat_columns = ['AGENT VERSIONS']
for date in existing_dates:
    flat_columns.extend(['DEVELOPMENT', 'QA', 'TOTAL SERVERS'])
combined_df.columns = flat_columns

# Save to Excel with pandas first
combined_df.to_excel(excel_file, index=False)

# Step 3: Apply formatting using openpyxl
wb = load_workbook(excel_file)
ws = wb.active

# Define styles
thin_border = Border(
    left=Side(style='thin'), right=Side(style='thin'),
    top=Side(style='thin'), bottom=Side(style='thin')
)
bold_border = Border(
    left=Side(style='medium'), right=Side(style='medium'),
    top=Side(style='medium'), bottom=Side(style='medium')
)
center_align = Alignment(horizontal='center', vertical='center')
left_align = Alignment(horizontal='left', vertical='center')
bold_font = Font(bold=True)
green_fill = PatternFill(start_color='00FF00', end_color='00FF00', fill_type='solid')

# Insert a new row at the top (row 1) for dates
ws.insert_rows(1)

# Assign dates and apply formatting
for idx, date in enumerate(existing_dates, start=1):
    # Calculate the column range for this date (e.g., B:D for first date)
    start_col = 2 + (idx - 1) * 3
    end_col = start_col + 2
    
    # Merge cells for the date (e.g., B1:D1 for first date)
    ws.merge_cells(start_row=1, start_column=start_col, end_row=1, end_column=end_col)
    # Set the date value
    cell = ws.cell(row=1, column=start_col)
    cell.value = date
    cell.alignment = center_align
    cell.font = bold_font
    # Apply bold border to the merged date cell
    for col in range(start_col, end_col + 1):
        ws.cell(row=1, column=col).border = bold_border

    # Apply bold border to the entire date block (all rows for these columns)
    for row in ws.iter_rows(min_row=2, max_row=ws.max_row, min_col=start_col, max_col=end_col):
        for cell in row:
            cell.border = bold_border

# Apply additional formatting to all cells: thin borders (overwritten by bold where applicable), alignment, bold for TOTAL row, and green highlight for 0
for row_idx, row in enumerate(ws.iter_rows(min_row=2, max_row=ws.max_row, min_col=1, max_col=ws.max_column), start=2):
    for col_idx, cell in enumerate(row, start=1):
        # Apply thin border to all cells (will be overwritten by bold border where applicable)
        cell.border = thin_border
        
        # Alignment: AGENT VERSIONS (column 1) is left-aligned, others are center-aligned
        if col_idx == 1:  # AGENT VERSIONS column
            cell.alignment = left_align
        else:
            cell.alignment = center_align
        
        # Bold the last row (TOTAL)
        if row_idx == ws.max_row:
            cell.font = bold_font
        
        # Highlight cells with value 0 in green (excluding AGENT VERSIONS column and header row)
        if col_idx > 1 and row_idx > 2 and cell.value == 0:
            cell.fill = green_fill

# Save the formatted Excel file
wb.save(excel_file)
print(f"Aggregated data for {date_str} successfully saved to {excel_file} with formatting")