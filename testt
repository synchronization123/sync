<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DefectDojo Report Generator</title>
  <!-- Include Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
</head>
<body>
  <div style="padding: 20px; font-family: Arial, sans-serif;">
    <h2>DefectDojo Report Generator</h2>
    <form id="reportForm">
      <label for="testIds">Test IDs (comma-separated):</label><br>
      <input type="text" id="testIds" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>
      
      <label for="reportName">Report Name:</label><br>
      <input type="text" id="reportName" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>
      
      <label for="startDate">Start Date:</label><br>
      <input type="text" id="startDate" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>
      
      <label for="endDate">End Date:</label><br>
      <input type="text" id="endDate" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>
      
      <label for="preparedBy">Prepared By:</label><br>
      <input type="text" id="preparedBy" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>
      
      <label for="reviewedBy">Reviewed By:</label><br>
      <input type="text" id="reviewedBy" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>
      
      <label for="approvedBy">Approved By:</label><br>
      <input type="text" id="approvedBy" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>
      
      <button type="submit" style="padding: 10px 20px; background-color: #20a6d8; color: white; border: none; cursor: pointer;">Generate Report</button>
    </form>
    <div id="status" style="margin-top: 20px;"></div>
  </div>

  <script>
    const API_URL = "https://demo.defectdojo.org/api/v2/findings/?test=";
    const BASE_URL = "https://demo.defectdojo.org"; // Base URL for relative image paths

    function getSeverityColor(severity) {
      if (severity === "Critical") return "maroon";
      if (severity === "High") return "red";
      if (severity === "Medium") return "orange";
      if (severity === "Low") return "yellow";
      if (severity === "Info") return "grey";
      return "transparent";
    }

    function stripVulnerabilityId(vulnerabilityId) {
      if (!vulnerabilityId || typeof vulnerabilityId !== "object") return "N/A";
      return vulnerabilityId.vulnerability_id ? vulnerabilityId.vulnerability_id.replace(/^{'vulnerability_id': '|'}$/g, "") : "N/A";
    }

    function generatePieChartSvg(severityCounts) {
      const canvas = document.createElement("canvas");
      canvas.width = 400;
      canvas.height = 200;
      const ctx = canvas.getContext("2d");

      const total = Object.values(severityCounts).reduce((a, b) => a + b, 0);

      new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(severityCounts).map(severity => {
            const count = severityCounts[severity];
            const percentage = total > 0 ? ((count * 100) / total).toFixed(2) : 0;
            return `${severity}, (${count}) (${percentage}%)`;
          }),
          datasets: [{
            data: Object.values(severityCounts),
            backgroundColor: Object.keys(severityCounts).map(severity => getSeverityColor(severity)),
            borderColor: "#fff",
            borderWidth: 2
          }]
        },
        options: {
          plugins: {
            title: {
              display: true,
              text: "Findings by Severity",
              font: { size: 16 }
            },
            legend: { display: true, position: "bottom" },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || "";
                  return label;
                }
              }
            }
          },
          responsive: false,
          maintainAspectRatio: false
        }
      });

      return `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="200"><image href="${canvas.toDataURL("image/png")}" width="400" height="200"/></svg>`;
    }

    function generateHtmlReport(findingData, reportName, startDate, endDate, preparedBy, reviewedBy, approvedBy) {
      const sortedFindings = findingData.sort((a, b) => {
        const severityOrder = ["Critical", "High", "Medium", "Low", "Info"];
        return severityOrder.indexOf(a.severity) - severityOrder.indexOf(b.severity);
      });

      const severityCounts = { Critical: 0, High: 0, Medium: 0, Low: 0, Info: 0 };
      sortedFindings.forEach(finding => {
        severityCounts[finding.severity]++;
      });

      const chartSvg = generatePieChartSvg(severityCounts);

      let htmlReport = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>DefectDojo Findings Report</title>
          <style>
            body { border: 1px solid #ccc; padding: 10px; font-size: 16px; font-family: Arial, sans-serif; }
            h1 { font-size: 18px; font-weight: bold; }
            .report-heading { font-size: 34px; font-weight: bold; }
            .finding-title { background-color: rgba(32, 166, 216, 0.75); color: white; padding: 10px; margin-top: 20px; }
            .severity-box { display: inline-block; padding: 5px; margin-bottom: 10px; color: white; }
            .severity-critical { background-color: maroon; }
            .severity-high { background-color: red; }
            .severity-medium { background-color: orange; }
            .severity-low { background-color: yellow; }
            .severity-info { background-color: grey; }
            .hardcoded-line { border-top: 1px solid #000; margin-top: 1px; padding-top: 1px; border-width: 1px; }
            .step-image { border: 1px solid #ccc; padding: 5px; margin-bottom: 10px; max-width: 1000px; max-height: 800px; width: auto; height: auto; display: block; }
            .steps_to_reproduce { list-style-type: none; padding-left: 0; }
            table { border-collapse: collapse; width: 100%; }
            th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
            .Sub-Title { font-size: 24px; }
            .chart-container { width: 400px; height: 200px; margin: 20px 0; }
            .image-error { color: red; font-style: italic; }
          </style>
        </head>
        <body>
          <div class="cover-page">
            <img src="logo" alt="Logo" onerror="this.style.display='none';">
            <h2 class="report-heading">${reportName}</h2>
            <h1>Application Security</h1>
            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
            <div class="Sub-Title">
              <p><strong>Report Properties:</strong></p>
              <p><strong>VAPT Dates:</strong></p>
            </div>
            <table>
              <tr><th>Start Date:</th><td>${startDate}</td></tr>
              <tr><th>End Date:</th><td>${endDate}</td></tr>
              <tr><th>Report Prepared by:</th><td>${preparedBy}</td></tr>
              <tr><th>Reviewed by:</th><td>${reviewedBy}</td></tr>
              <tr><th>Approved by:</th><td>${approvedBy}</td></tr>
            </table>
          </div>
          <br><br><br><br><br>
          <div class="chart-container">${chartSvg}</div>
      `;

      const severityFindings = {};
      const severityColors = {
        Critical: { background: "maroon", font: "black" },
        High: { background: "red", font: "black" },
        Medium: { background: "orange", font: "black" },
        Low: { background: "yellow", font: "black" },
        Info: { background: "grey", font: "black" }
      };

      sortedFindings.forEach(finding => {
        const severity = finding.severity;
        if (!severityFindings[severity]) severityFindings[severity] = [];
        severityFindings[severity].push(finding);
      });

      htmlReport += `<h2 id="top">Findings Index</h2>`;
      const severityOrder = ["Critical", "High", "Medium", "Low", "Info"];
      severityOrder.forEach(severity => {
        const findings = severityFindings[severity] || [];
        if (findings.length > 0) {
          const color = severityColors[severity] || { background: "white", font: "black" };
          htmlReport += `
            <h1 style="background-color: ${color.background}; color: ${color.font}">${severity} Findings:</h1>
            <ul>
          `;
          findings.forEach((finding, index) => {
            const globalIndex = sortedFindings.indexOf(finding) + 1;
            htmlReport += `<li><a href="#finding${globalIndex}">Finding ${globalIndex}: ${finding.title}</a></li>`;
          });
          htmlReport += `</ul>`;
        }
      });

      htmlReport += `<br><br><br><p><h2 id="top">Findings Details</h2></p>`;

      sortedFindings.forEach((finding, index) => {
        const findingTitle = finding.title;
        const vulnerabilityId = finding.vulnerability_ids[0] ? stripVulnerabilityId(finding.vulnerability_ids[0]) : "N/A";
        const description = finding.description.replace(/\r\n/g, "<br>");
        const cvssv3 = finding.cvssv3 || "N/A";
        const cvssv3Score = finding.cvssv3_score || "N/A";
        const severity = finding.severity;
        const stepsToReproduce = finding.steps_to_reproduce.replace(/\r\n/g, "<br>");
        const mitigation = finding.mitigation.replace(/\r\n/g, "<br>");
        const impact = finding.impact.replace(/\r\n/g, "<br>");

        htmlReport += `
          <br><br><br>
          <div id="finding${index + 1}" class="finding-border">
            <div class="finding-title">
              <h1>Finding ${index + 1}: ${findingTitle}</h1>
            </div>
          </div>
          <p><strong>Jira ID:</strong> ${vulnerabilityId}</p>
          <hr class="hardcoded-line">
          <p><strong>Description:</strong> ${description}</p>
          <hr class="hardcoded-line">
          <p><strong>CVSSv3:</strong> ${cvssv3}</p>
          <hr class="hardcoded-line">
          <p><strong>CVSSv3 Score:</strong> ${cvssv3Score}</p>
          <hr class="hardcoded-line">
          <div class="severity-box severity-${severity.toLowerCase()}" style="background-color: ${getSeverityColor(severity)};">
            <strong>Severity:</strong> ${severity}
          </div>
          <hr class="hardcoded-line">
          <p><strong>Impact:</strong> ${impact}</p>
          <hr class="hardcoded-line">
          <p><strong>Mitigation:</strong> ${mitigation}</p>
          <hr class="hardcoded-line">
          <p><strong>Steps to Reproduce:</strong></p>
          <ul class="steps_to_reproduce">
        `;

        const steps = stepsToReproduce.split("<br>");
        steps.forEach(step => {
          const imgRegex = /!\[\]\(([^)]+)\)/g;
          let modifiedStep = step;
          let match;
          while ((match = imgRegex.exec(step)) !== null) {
            let imgUrl = match[1];
            if (imgUrl.startsWith("/access_file/")) {
              imgUrl = `${BASE_URL}${imgUrl}`;
            }
            modifiedStep = modifiedStep.replace(
              `![](${match[1]})`,
              `<img class="step-image" src="${imgUrl}" style="max-width: 1000px; max-height: 800px; width: auto; height: auto; display: block;" onerror="this.style.display='none'; this.nextSibling.style.display='block';" alt="Finding Image"><span class="image-error" style="display: none;">Failed to load image: ${imgUrl}</span><br>`
            );
          }
          htmlReport += `<li>${modifiedStep}</li>`;
        });

        htmlReport += `</ul><hr></div>`;
      });

      htmlReport += `</body></html>`;
      return htmlReport;
    }

    document.getElementById("reportForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const statusDiv = document.getElementById("status");
      statusDiv.innerHTML = "Generating report...";

      const testIds = document.getElementById("testIds").value.split(",").map(id => id.trim());
      const reportName = document.getElementById("reportName").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const preparedBy = document.getElementById("preparedBy").value;
      const reviewedBy = document.getElementById("reviewedBy").value;
      const approvedBy = document.getElementById("approvedBy").value;

      const findingData = [];

      for (const testId of testIds) {
        try {
          const response = await fetch(`${API_URL}${testId}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json"
            },
            credentials: "include" // Include session cookies
          });

          if (response.ok) {
            const reportData = await response.json();
            const findings = reportData.results || [];
            if (findings.length > 0) {
              findingData.push(...findings);
              statusDiv.innerHTML += `<p>Findings fetched for Test ID: ${testId}</p>`;
            } else {
              statusDiv.innerHTML += `<p>No findings found for Test ID: ${testId}</p>`;
            }
          } else {
            statusDiv.innerHTML += `<p>Error fetching findings for Test ID: ${testId}. Status code: ${response.status}</p>`;
          }
        } catch (error) {
          statusDiv.innerHTML += `<p>Error fetching findings for Test ID: ${testId}. Error: ${error.message}</p>`;
        }
      }

      if (findingData.length > 0) {
        const htmlReport = generateHtmlReport(findingData, reportName, startDate, endDate, preparedBy, reviewedBy, approvedBy);
        const blob = new Blob([htmlReport], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "report.html";
        a.click();
        URL.revokeObjectURL(url);
        statusDiv.innerHTML += `<p>HTML report generated and downloaded as report.html. Note: Images may require viewing within an authenticated session to render correctly.</p>`;
      } else {
        statusDiv.innerHTML += `<p>No findings to generate report.</p>`;
      }
    });
  </script>
</body>
</html>