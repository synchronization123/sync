import pandas as pd
import requests
import re
from urllib.parse import urlparse
import base64
import os

# Configuration
BITBUCKET_API_BASE = "https://bitbucket.crm.com/rest/api/1.0"  # Bitbucket Server API
TOKEN = "jdjdjdjd"  # Replace with your actual Personal Access Token
USERNAME = "your-username"  # Replace with your Bitbucket Server username
EXCEL_FILE = "repos.xlsx"  # Path to your Excel file
OUTPUT_FILE = "repo_owners.xlsx"  # Output file for results

# Encode credentials for Basic Authentication
credentials = f"{USERNAME}:{TOKEN}"
auth_header = f"Basic {base64.b64encode(credentials.encode()).decode()}"

# Headers for API requests
headers = {
    "Authorization": auth_header,
    "Accept": "application/json"
}

def parse_repo_url(url):
    """Extract project key and repo slug from Bitbucket Server URL."""
    try:
        # Normalize URL
        parsed_url = urlparse(url)
        path = parsed_url.path.strip("/")
        # Expected format: projects/ProjectName/repos/RepoName
        match = re.match(r"projects/([^/]+)/repos/([^/]+)", path)
        if match:
            project_key = match.group(1)
            repo_slug = match.group(2)
            return project_key, repo_slug
        else:
            print(f"Invalid URL format: {url}")
            return None, None
    except Exception as e:
        print(f"Error parsing URL {url}: {e}")
        return None, None

def get_repo_owner(project_key, repo_slug):
    """Fetch the owner of a Bitbucket Server repository using the API."""
    if not project_key or not repo_slug:
        return None
    try:
        # Get repository details
        url = f"{BITBUCKET_API_BASE}/projects/{project_key}/repos/{repo_slug}"
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            repo_data = response.json()
            # Bitbucket Server doesn't directly provide an "owner" field
            # Check for creator or project owner
            project_url = f"{BITBUCKET_API_BASE}/projects/{project_key}"
            project_response = requests.get(project_url, headers=headers)
            owner = "Unknown"
            if project_response.status_code == 200:
                project_data = project_response.json()
                # Try to get project creator or owner (if available)
                owner = project_data.get("owner", {}).get("displayName", "Unknown")
            return owner
        elif response.status_code == 401:
            print(f"Unauthorized access for {project_key}/{repo_slug}. Check token permissions.")
            return None
        elif response.status_code == 404:
            print(f"Repository not found: {project_key}/{repo_slug}")
            return None
        else:
            print(f"Error fetching {project_key}/{repo_slug}: {response.status_code} - {response.text}")
            return None
    except Exception as e:
        print(f"Exception fetching {project_key}/{repo_slug}: {e}")
        return None

def main():
    # Read Excel file
    try:
        df = pd.read_excel(EXCEL_FILE)
    except Exception as e:
        print(f"Error reading Excel file: {e}")
        return

    # Assume URLs are in a column named 'URL' (adjust as needed)
    if 'URL' not in df.columns:
        print("Excel file must contain a 'URL' column with repository URLs.")
        return

    # Lists to store results
    results = []

    # Process each URL
    for url in df['URL']:
        project_key, repo_slug = parse_repo_url(url)
        if project_key and repo_slug:
            owner = get_repo_owner(project_key, repo_slug)
            results.append({"URL": url, "Project": project_key, "Repo": repo_slug, "Owner": owner})
        else:
            results.append({"URL": url, "Project": None, "Repo": None, "Owner": None})

    # Create a DataFrame with results
    result_df = pd.DataFrame(results)
    
    # Save results to a new Excel file
    try:
        result_df.to_excel(OUTPUT_FILE, index=False)
        print(f"Results saved to {OUTPUT_FILE}")
    except Exception as e:
        print(f"Error saving results to Excel: {e}")

    # Print results
    print("\nRepository Owners:")
    print(result_df)

if __name__ == "__main__":
    main()