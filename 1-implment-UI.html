import requests
import pandas as pd
import os
from datetime import datetime

# Input data (assuming you have an Excel file with API URLs and tokens)
input_excel = 'input.xlsx'  # Your input Excel with 300 rows
output_dir = 'output_excels'
os.makedirs(output_dir, exist_ok=True)

# Read input Excel
df_input = pd.read_excel(input_excel)

# Function to fetch commit data
def fetch_commits(api_url, token):
    headers = {'Authorization': f'Bearer {token}'}
    commits_data = []
    
    try:
        response = requests.get(api_url, headers=headers)
        response.raise_for_status()
        data = response.json()
        
        for commit in data.get('values', []):
            commits_data.append({
                'Owner Name': commit.get('author', {}).get('displayName', ''),
                'Report URL': f"{api_url.rsplit('/', 1)[0]}/{commit.get('id', '')}"
            })
            
        return commits_data
    
    except Exception as e:
        print(f"Error fetching data for {api_url}: {str(e)}")
        return []

# Process each row
all_dfs = []
for index, row in df_input.iterrows():
    api_url = row['Api']  # Column name in your input Excel
    token = row['Token']  # Column name in your input Excel
    
    # Extract PROJECTNAME and REPONAME from URL
    parts = api_url.split('/')
    project_name = parts[parts.index('projects') + 1]
    repo_name = parts[parts.index('repos') + 1]
    
    # Fetch commit data
    commits = fetch_commits(api_url, token)
    
    if commits:
        # Create DataFrame
        df_commits = pd.DataFrame(commits)
        
        # Save to individual Excel
        output_file = os.path.join(output_dir, f"{project_name}-{repo_name}.xlsx")
        df_commits.to_excel(output_file, index=False)
        print(f"Saved: {output_file}")
        
        # Add project and repo info for merged file
        df_commits['Project Name'] = project_name
        df_commits['Repository Name'] = repo_name
        all_dfs.append(df_commits)

# Merge all DataFrames and save to merged.xlsx
if all_dfs:
    merged_df = pd.concat(all_dfs, ignore_index=True)
    merged_file = 'merged.xlsx'
    merged_df.to_excel(merged_file, index=False)
    print(f"Merged file saved: {merged_file}")
else:
    print("No data to merge")