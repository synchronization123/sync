<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patch and Test Case Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom CSS for additional styling */
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .status-pass { color: #28a745; font-weight: bold; }
        .status-fail { color: #dc3545; font-weight: bold; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-not-started { color: #6c757d; font-weight: bold; }
        .status-certified { color: #28a745; font-weight: bold; }
        .status-not-certified { color: #dc3545; font-weight: bold; }
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }
        .loading::after {
            content: 'Loading...';
            color: white;
            font-size: 24px;
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-container .form-control, .filter-container .form-select {
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Patch and Test Case Management</h1>

        <!-- Add New Patch Form -->
        <!-- START ADD NEW PATCH -->
        <div class="mb-3">
            <button class="btn btn-primary" onclick="openAddPatchModal()">Add New Patch</button>
        </div>
        <div class="modal fade" id="addPatchModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Patch</h5>
                        <button type="button" class="btn-close" onclick="closeModal('addPatchModal')"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addPatchForm">
                            <input type="hidden" name="csrfmiddlewaretoken" id="csrfToken">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target Start</label>
                                <input type="date" class="form-control" name="target_start" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target End</label>
                                <input type="date" class="form-control" name="target_end" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="Not Started">Not Started</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Engagement Type</label>
                                <select class="form-select" name="engagement_type">
                                    <option value="Interactive">Interactive</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lead</label>
                                <input type="text" class="form-control" name="lead">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Product</label>
                                <input type="text" class="form-control" name="product">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tags</label>
                                <input type="text" class="form-control" name="tags" placeholder="e.g., rmm">
                            </div>
                            <button type="submit" class="btn btn-success">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- END ADD NEW PATCH -->

        <!-- Filters -->
        <!-- START FILTERS -->
        <div class="filter-container">
            <input type="text" class="form-control" id="filterBuild" placeholder="Build/Patch">
            <input type="text" class="form-control" id="filterBuildID" placeholder="Build ID">
            <input type="text" class="form-control" id="filterLead" placeholder="Lead">
            <input type="text" class="form-control" id="filterProduct" placeholder="Product">
            <input type="date" class="form-control" id="filterDate" placeholder="Date">
            <input type="date" class="form-control" id="filterStartDate" placeholder="Start Date">
            <input type="date" class="form-control" id="filterCompletionDate" placeholder="Completion Date">
            <select class="form-select" id="filterBuildStatus">
                <option value="">Build Status</option>
                <option value="Completed">Completed</option>
                <option value="Pending">Pending</option>
            </select>
            <select class="form-select" id="filterCertification">
                <option value="">Certification</option>
                <option value="Certified">Certified</option>
                <option value="Not Certified">Not Certified</option>
                <option value="Pending">Pending</option>
            </select>
        </div>
        <!-- END FILTERS -->

        <!-- Engagement Table -->
        <!-- START ENGAGEMENT TABLE -->
        <div class="mb-3">Total Count: <span id="totalEngagements">0</span></div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="engagementTable">
                <thead class="table-primary">
                    <tr>
                        <th>Build/Patch</th>
                        <th>Build ID</th>
                        <th>Lead</th>
                        <th>Product</th>
                        <th>Date</th>
                        <th>Start Date</th>
                        <th>Completion Date</th>
                        <th>Total Test Cases</th>
                        <th>Completed</th>
                        <th>Passed</th>
                        <th>Failed</th>
                        <th>Build Status</th>
                        <th>Certification</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <nav aria-label="Engagement pagination">
            <ul class="pagination justify-content-center" id="engagementPagination"></ul>
        </nav>
        <!-- END ENGAGEMENT TABLE -->

        <!-- Test Cases Modal -->
        <!-- START TEST CASES MODAL -->
        <div class="modal fade" id="testCasesModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Test Cases</h5>
                        <button type="button" class="btn-close" onclick="closeModal('testCasesModal')"></button>
                    </div>
                    <div class="modal-body">
                        <div class="filter-container">
                            <input type="text" class="form-control" id="filterTestID" placeholder="Search by ID">
                            <select class="form-select" id="filterTestStatus">
                                <option value="">Test Case Status</option>
                                <option value="All">All</option>
                                <option value="Active">Active</option>
                                <option value="InActive">InActive</option>
                                <option value="Retired">Retired</option>
                            </select>
                            <select class="form-select" id="filterCategory"></select>
                            <select class="form-select" id="filterModality">
                                <option value="">Modality</option>
                                <option value="Web">Web</option>
                                <option value="Mobile">Mobile</option>
                                <option value="Thick">Thick</option>
                            </select>
                            <button class="btn btn-primary" onclick="openAddTestCaseModal()">Add New Test Case</button>
                        </div>
                        <div class="mb-3">Total Count: <span id="totalTestCases">0</span></div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="testCasesTable">
                                <thead class="table-primary">
                                    <tr>
                                        <th>ID</th>
                                        <th>Category</th>
                                        <th>Test Case Title</th>
                                        <th>Test Case Description</th>
                                        <th>Modality</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <nav aria-label="Test cases pagination">
                            <ul class="pagination justify-content-center" id="testCasesPagination"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        <!-- END TEST CASES MODAL -->

        <!-- Add New Test Case Modal -->
        <!-- START ADD NEW TEST CASE MODAL -->
        <div class="modal fade" id="addTestCaseModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Test Case</h5>
                        <button type="button" class="btn-close" onclick="closeModal('addTestCaseModal')"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addTestCaseForm">
                            <input type="hidden" name="csrfmiddlewaretoken" id="csrfTokenTestCase">
                            <div class="mb-3">
                                <label class="form-label">ID</label>
                                <input type="text" class="form-control" name="id" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" name="category" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Test Case Title</label>
                                <input type="text" class="form-control" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Test Case Description</label>
                                <textarea class="form-control" name="description" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Modality</label>
                                <select class="form-select" name="modality" required>
                                    <option value="Web">Web</option>
                                    <option value="Mobile">Mobile</option>
                                    <option value="Thick">Thick</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Test Type Name</label>
                                <input type="text" class="form-control" name="test_type_name" value="Contrast Scan" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Test Type</label>
                                <input type="number" class="form-control" name="test_type" value="41" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Environment</label>
                                <input type="number" class="form-control" name="environment" value="6" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target Start</label>
                                <input type="date" class="form-control" name="target_start" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target End</label>
                                <input type="date" class="form-control" name="target_end" required>
                            </div>
                            <button type="submit" class="btn btn-success">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- END ADD NEW TEST CASE MODAL -->

        <!-- Mapping Modal -->
        <!-- START MAPPING MODAL -->
        <div class="modal fade" id="mappingModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Mapping</h5>
                        <button type="button" class="btn-close" onclick="closeModal('mappingModal')"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Engagement</label>
                            <select class="form-select" id="engagementSelect" onchange="loadJiraTestCases()"></select>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="jiraTable">
                                <thead class="table-primary">
                                    <tr>
                                        <th>ID</th>
                                        <th>Jira</th>
                                        <th>Assigned To</th>
                                        <th>Analysis Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="mappingTestCases" style="display: none;">
                            <h5>Select Test Cases</h5>
                            <div class="filter-container">
                                <input type="text" class="form-control" id="filterMappingTestID" placeholder="Search by ID">
                                <select class="form-select" id="filterMappingCategory"></select>
                                <select class="form-select" id="filterMappingModality">
                                    <option value="">Modality</option>
                                    <option value="Web">Web</option>
                                    <option value="Mobile">Mobile</option>
                                    <option value="Thick">Thick</option>
                                </select>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered" id="mappingTestCasesTable">
                                    <thead class="table-primary">
                                        <tr>
                                            <th><input type="checkbox" id="selectAllTests" onclick="toggleSelectAll()"></th>
                                            <th>ID</th>
                                            <th>Category</th>
                                            <th>Test Case Title</th>
                                            <th>Modality</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <button class="btn btn-success" onclick="mapTestCases()">Map</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END MAPPING MODAL -->

        <!-- Toast Container -->
        <div class="toast-container">
            <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-body"></div>
            </div>
        </div>

        <!-- Loading Modal -->
        <div id="loading" class="loading"></div>
    </div>

    <!-- Bootstrap JS and Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript for dynamic functionality
        const BASE_URL = 'https://demo.defectdojo.org';
        let currentPage = 1;
        let testCasesPage = 1;
        const itemsPerPage = 10;
        const testCasesPerPage = 10;

        // Modal controls
        function openModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }

        function closeModal(modalId) {
            const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
            if (modal) modal.hide();
        }

        function showToast(message) {
            const toastEl = document.getElementById('toast');
            toastEl.querySelector('.toast-body').textContent = message;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Fetch CSRF token
        async function fetchCsrfToken() {
            showLoading();
            try {
                const response = await fetch('https://dojo.com/api/key-v2');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const csrfToken = doc.querySelector('input[name="csrfmiddlewaretoken"]').value;
                document.querySelectorAll('[name="csrfmiddlewaretoken"]').forEach(input => {
                    input.value = csrfToken;
                });
            } catch (error) {
                showToast('Failed to fetch CSRF token');
            } finally {
                hideLoading();
            }
        }

        // Open Add Patch Modal
        function openAddPatchModal() {
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            document.querySelector('#addPatchForm [name="target_start"]').value = today;
            document.querySelector('#addPatchForm [name="target_end"]').value = tomorrow;
            openModal('addPatchModal');
        }

        // Load Engagements
        async function loadEngagements(page = 1) {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/v2/engagements`, {
                    headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
                });
                const data = await response.json();
                const engagements = data.results || [];
                
                // Fetch test case counts for each engagement
                const enrichedEngagements = await Promise.all(engagements.map(async (e) => {
                    const testResponse = await fetch(`${BASE_URL}/api/v2/tests/?engagement=${e.id}&tags=rmm_jiras`, {
                        headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
                    });
                    const tests = await testResponse.json();
                    const totalTests = tests.count || 0;
                    const completedTests = tests.results?.filter(t => t.branch_tag === 'Completed').length || 0;
                    const passedTests = tests.results?.filter(t => t.branch_tag === 'Passed').length || 0;
                    const failedTests = tests.results?.filter(t => t.branch_tag === 'Failed').length || 0;
                    return {
                        ...e,
                        build_patch: e.build_patch || 'Patch',
                        build_id: e.name || e.id,
                        lead: e.lead?.name || '',
                        product: e.product?.name || '',
                        created: e.created?.split('T')[0] || '',
                        total_test_cases: totalTests,
                        completed: completedTests,
                        passed: passedTests,
                        failed: failedTests
                    };
                }));

                const filteredEngagements = enrichedEngagements.filter(e => {
                    return (
                        (!document.getElementById('filterBuild').value || e.build_patch.toLowerCase().includes(document.getElementById('filterBuild').value.toLowerCase())) &&
                        (!document.getElementById('filterBuildID').value || e.build_id.toLowerCase().includes(document.getElementById('filterBuildID').value.toLowerCase())) &&
                        (!document.getElementById('filterLead').value || e.lead.toLowerCase().includes(document.getElementById('filterLead').value.toLowerCase())) &&
                        (!document.getElementById('filterProduct').value || e.product.toLowerCase().includes(document.getElementById('filterProduct').value.toLowerCase())) &&
                        (!document.getElementById('filterDate').value || e.created === document.getElementById('filterDate').value) &&
                        (!document.getElementById('filterStartDate').value || e.target_start === document.getElementById('filterStartDate').value) &&
                        (!document.getElementById('filterCompletionDate').value || e.target_end === document.getElementById('filterCompletionDate').value) &&
                        (!document.getElementById('filterBuildStatus').value || e.status === document.getElementById('filterBuildStatus').value) &&
                        (!document.getElementById('filterCertification').value || e.commit_hash === document.getElementById('filterCertification').value)
                    );
                });

                const start = (page - 1) * itemsPerPage;
                const paginatedEngagements = filteredEngagements.slice(start, start + itemsPerPage);

                const tbody = document.querySelector('#engagementTable tbody');
                tbody.innerHTML = '';
                paginatedEngagements.forEach(e => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${e.build_patch}</td>
                        <td>${e.build_id}</td>
                        <td>${e.lead}</td>
                        <td>${e.product}</td>
                        <td>${e.created}</td>
                        <td>${e.target_start || ''}</td>
                        <td>${e.target_end || ''}</td>
                        <td><a href="#" onclick="openTestCasesModal()">${e.total_test_cases}</a></td>
                        <td>${e.completed}</td>
                        <td class="status-pass">${e.passed}</td>
                        <td class="status-fail">${e.failed}</td>
                        <td class="status-${(e.status || '').toLowerCase().replace(' ', '-') || 'not-started'}">${e.status || 'Not Started'}</td>
                        <td class="status-${(e.commit_hash || '').toLowerCase().replace(' ', '-') || 'pending'}">${e.commit_hash || 'Pending'}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="openTestCasesModal()">Test Cases</button>
                            <button class="btn btn-primary btn-sm" onclick="openMappingModal(${e.id})">Mapping</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('totalEngagements').textContent = filteredEngagements.length;
                renderPagination(filteredEngagements.length, page, 'engagementPagination', loadEngagements);
            } catch (error) {
                showToast('Failed to load engagements');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        // Render Pagination
        function renderPagination(totalItems, currentPage, containerId, callback) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="${callback.name}(${i}); return false;">${i}</a>`;
                container.appendChild(li);
            }
        }

        // Test Cases Modal
        function openTestCasesModal() {
            openModal('testCasesModal');
            loadTestCases();
            loadCategories();
        }

        async function loadTestCases(page = 1) {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/v2/tests/?engagement=1233&tags=master_test_cases`, {
                    headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
                });
                const data = await response.json();
                const testCases = data.results || [];
                
                const filteredTestCases = testCases.filter(tc => {
                    return (
                        (!document.getElementById('filterTestID').value || tc.id.toString().includes(document.getElementById('filterTestID').value)) &&
                        (!document.getElementById('filterTestStatus').value || document.getElementById('filterTestStatus').value === 'All' || tc.status === document.getElementById('filterTestStatus').value) &&
                        (!document.getElementById('filterCategory').value || tc.category === document.getElementById('filterCategory').value) &&
                        (!document.getElementById('filterModality').value || tc.modality === document.getElementById('filterModality').value)
                    );
                });

                const start = (page - 1) * testCasesPerPage;
                const paginatedTestCases = filteredTestCases.slice(start, start + testCasesPerPage);

                const tbody = document.querySelector('#testCasesTable tbody');
                tbody.innerHTML = '';
                paginatedTestCases.forEach(tc => {
                    const shortDesc = tc.description ? tc.description.split(' ').slice(0, 5).join(' ') + (tc.description.split(' ').length > 5 ? '...' : '') : '';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tc.id || ''}</td>
                        <td>${tc.category || ''}</td>
                        <td>${tc.title || ''}</td>
                        <td>${shortDesc} <a href="#" onclick="alert('${tc.description || ''}')">See more</a></td>
                        <td>${tc.modality || ''}</td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('totalTestCases').textContent = filteredTestCases.length;
                renderPagination(filteredTestCases.length, page, 'testCasesPagination', loadTestCases);
            } catch (error) {
                showToast('Failed to load test cases');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${BASE_URL}/api/v2/tests/?engagement=1233`, {
                    headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
                });
                const data = await response.json();
                const categories = [...new Set(data.results?.map(tc => tc.category).filter(Boolean))];
                const select = document.getElementById('filterCategory');
                select.innerHTML = '<option value="">Category</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            } catch (error) {
                showToast('Failed to load categories');
                console.error(error);
            }
        }

        // Add New Test Case Modal
        function openAddTestCaseModal() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#addTestCaseForm [name="target_start"]').value = today;
            document.querySelector('#addTestCaseForm [name="target_end"]').value = today;
            openModal('addTestCaseModal');
        }

        // Mapping Modal
        function openMappingModal(engagementId) {
            currentEngagementId = engagementId;
            openModal('mappingModal');
            loadEngagementSelect();
        }

        async function loadEngagementSelect() {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/v2/engagements?active=true`, {
                    headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
                });
                const data = await response.json();
                const engagements = data.results || [];
                const select = document.getElementById('engagementSelect');
                select.innerHTML = '<option value="">Select Engagement</option>';
                engagements.forEach(eng => {
                    const option = document.createElement('option');
                    option.value = eng.id;
                    option.textContent = `${eng.name || eng.id} - ${eng.product?.name || ''}`;
                    select.appendChild(option);
                });
                if (currentEngagementId) {
                    select.value = currentEngagementId;
                    loadJiraTestCases();
                }
            } catch (error) {
                showToast('Failed to load engagements');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        async function loadJiraTestCases() {
            showLoading();
            try {
                const engagementId = document.getElementById('engagementSelect').value;
                if (!engagementId) {
                    document.querySelector('#jiraTable tbody').innerHTML = '';
                    document.getElementById('mappingTestCases').style.display = 'none';
                    return;
                }
                const response = await fetch(`${BASE_URL}/api/v2/tests/?engagement=${engagementId}&tags=rmm_jiras`, {
                    headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
                });
                const data = await response.json();
                const jiraTestCases = data.results || [];
                
                const tbody = document.querySelector('#jiraTable tbody');
                tbody.innerHTML = '';
                jiraTestCases.forEach(jira => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${jira.id || ''}</td>
                        <td>${jira.title || ''}</td>
                        <td>${jira.lead?.name || ''}</td>
                        <td class="status-${(jira.analysis_status || 'Not Started').toLowerCase().replace(' ', '-') || 'not-started'}">${jira.analysis_status || 'Not Started'}</td>
                        <td><button class="btn btn-primary btn-sm" onclick="openMappingTestCases(${jira.id})">Map</button></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                showToast('Failed to load Jira test cases');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        async function openMappingTestCases(jiraId) {
            currentJiraId = jiraId;
            document.getElementById('mappingTestCases').style.display = 'block';
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/v2/tests/?engagement=1233&tags=master_test_cases`, {
                    headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
                });
                const data = await response.json();
                const testCases = data.results || [];
                
                const filteredTestCases = testCases.filter(tc => {
                    return (
                        (!document.getElementById('filterMappingTestID').value || tc.id.toString().includes(document.getElementById('filterMappingTestID').value)) &&
                        (!document.getElementById('filterMappingCategory').value || tc.category === document.getElementById('filterMappingCategory').value) &&
                        (!document.getElementById('filterMappingModality').value || tc.modality === document.getElementById('filterMappingModality').value)
                    );
                });

                const tbody = document.querySelector('#mappingTestCasesTable tbody');
                tbody.innerHTML = '';
                filteredTestCases.forEach(tc => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" value="${tc.id}"></td>
                        <td>${tc.id || ''}</td>
                        <td>${tc.category || ''}</td>
                        <td>${tc.title || ''}</td>
                        <td>${tc.modality || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
                loadMappingCategories();
            } catch (error) {
                showToast('Failed to load test cases');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        async function loadMappingCategories() {
            try {
                const response = await fetch(`${BASE_URL}/api/v2/tests/?engagement=1233`, {
                    headers: { 'X-CSRFToken': document.getElementById('csrfToken').value }
                });
                const data = await response.json();
                const categories = [...new Set(data.results?.map(tc => tc.category).filter(Boolean))];
                const select = document.getElementById('filterMappingCategory');
                select.innerHTML = '<option value="">Category</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            } catch (error) {
                showToast('Failed to load categories');
                console.error(error);
            }
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#mappingTestCasesTable input[type="checkbox"]');
            const selectAll = document.getElementById('selectAllTests');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        async function mapTestCases() {
            showLoading();
            try {
                const selectedTests = Array.from(document.querySelectorAll('#mappingTestCasesTable input[type="checkbox"]:checked')).map(cb => cb.value);
                if (selectedTests.length === 0) {
                    showToast('No test cases selected');
                    return;
                }
                const engagementId = document.getElementById('engagementSelect').value;
                // Update the test's commit_hash with selected test IDs
                await fetch(`${BASE_URL}/api/v2/tests/${currentJiraId}`, {
                    method: 'PATCH',
                    headers: {
                        'X-CSRFToken': document.getElementById('csrfToken').value,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ commit_hash: selectedTests.join(',') })
                });
                showToast('Test cases mapped');
                document.getElementById('mappingTestCases').style.display = 'none';
                loadJiraTestCases();
            } catch (error) {
                showToast('Failed to map test cases');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        // Add Patch Form Submission
        document.getElementById('addPatchForm').onsubmit = async (e) => {
            e.preventDefault();
            showLoading();
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                data.tags = data.tags ? data.tags.split(',').map(tag => tag.trim()) : ['rmm'];
                if (data.commit_hash === 'Certified' || data.commit_hash === 'Not Certified') {
                    data.status = 'Completed';
                }
                await fetch(`${BASE_URL}/api/v2/engagements`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.getElementById('csrfToken').value,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                showToast('Patch added successfully');
                closeModal('addPatchModal');
                loadEngagements(currentPage);
            } catch (error) {
                showToast('Failed to add patch');
                console.error(error);
            } finally {
                hideLoading();
            }
        };

        // Add Test Case Form Submission
        document.getElementById('addTestCaseForm').onsubmit = async (e) => {
            e.preventDefault();
            showLoading();
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                data.tags = ['master_test_cases'];
                data.engagement = 1233;
                await fetch(`${BASE_URL}/api/v2/tests`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.getElementById('csrfTokenTestCase').value,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                showToast('Test case added');
                closeModal('addTestCaseModal');
                loadTestCases(testCasesPage);
            } catch (error) {
                showToast('Failed to add test case');
                console.error(error);
            } finally {
                hideLoading();
            }
        };

        // Filter Listeners
        document.querySelectorAll('.filter-container input, .filter-container select').forEach(element => {
            element.addEventListener('change', () => loadEngagements(1));
        });

        // Initialize
        fetchCsrfToken();
        loadEngagements();
    </script>
</body>
</html>