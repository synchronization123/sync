import datetime
import calendar
import pandas as pd
from openpyxl import Workbook, load_workbook
from openpyxl.styles import Alignment, Font, PatternFill
from openpyxl.utils import get_column_letter
import os
import requests
import json

# ===== CONFIGURATION - EDIT THESE VALUES =====
JIRA_URL = "https://demo.jira.com/rest/api/2/search/"  # Your Jira API endpoint
JIRA_API_TOKEN = "hdjdjdjdjdj"  # Your Bearer token
# =============================================

def get_jira_connection():
    """Authenticate to Jira server using Bearer token"""
    headers = {
        "Authorization": f"Bearer {JIRA_API_TOKEN}",
        "Content-Type": "application/json"
    }
    return headers

def calculate_cutoff_dates():
    """Calculate SLA cutoff dates based on severity"""
    today = datetime.date.today()
    last_day = calendar.monthrange(today.year, today.month)[1]
    end_of_month = datetime.date(today.year, today.month, last_day)
    
    return {
        'Critical': end_of_month - datetime.timedelta(days=15),
        'High': end_of_month - datetime.timedelta(days=30),
        'Medium': end_of_month - datetime.timedelta(days=90),
        'Low': end_of_month - datetime.timedelta(days=365)
    }

def generate_jql(cutoff_dates):
    """Generate JQL query based on SLA cutoffs"""
    return f'''
    labels in ("sqli", "xss") 
    AND project in (cmr, dmr) 
    AND issuetype not in (epic, story) 
    AND component = "techdebt" 
    AND status not in (retrospected)
    AND (
        (severity = "Critical" AND created <= "{cutoff_dates['Critical']}")
        OR (severity = "High" AND created <= "{cutoff_dates['High']}")
        OR (severity = "Medium" AND created <= "{cutoff_dates['Medium']}")
        OR (severity = "Low" AND created <= "{cutoff_dates['Low']}")
    )
    '''.strip()

def get_status_category(status):
    """Categorize status into development or testing"""
    if not status:
        return None
    status = status.lower().strip()
    if status in ["done", "ready for testing"]:
        return "For Testing"
    else:
        print(f"Status '{status}' categorized as 'In Development'")
        return "In Development"

def fetch_issues(headers, jql):
    """Fetch issues from Jira using the REST API with specific fields"""
    params = {
        "jql": jql,
        "maxResults": 1000,
        "fields": "project,key,status"  # Request only project, key, status
    }
    response = requests.get(JIRA_URL, headers=headers, params=params)
    
    if response.status_code != 200:
        raise Exception(f"Failed to fetch issues: {response.status_code} - {response.text}")
    
    data = response.json()
    return data.get('issues', [])

def process_issues(issues):
    """Process issues into categorized counts and collect raw data"""
    counts = {
        'cmr': {'In Development': 0, 'For Testing': 0},
        'dmr': {'In Development': 0, 'For Testing': 0}
    }
    raw_issues = []  # Store project, key, status for visualization
    
    print(f"\nProcessing {len(issues)} issues...")
    for issue in issues:
        try:
            project = issue.get('fields', {}).get('project', {}).get('key', '').lower()
            key = issue.get('key', '')
            status = issue.get('fields', {}).get('status', {}).get('name', '')
            category = get_status_category(status)
            
            # Store raw issue data
            raw_issues.append({
                'project': project.upper(),
                'key': key,
                'status': status
            })
            
            print(f"Issue {key}: Project={project}, Status={status}, Category={category}")
            
            if project in counts and category:
                counts[project][category] += 1
            else:
                print(f"Skipped issue {key}: Invalid project ({project}) or category ({category})")
        except Exception as e:
            print(f"Error processing issue {issue.get('key', 'unknown')}: {str(e)}")
    
    print("\nFinal counts:")
    print(json.dumps(counts, indent=2))
    return counts, raw_issues

def update_excel_report(today_str, counts, raw_issues):
    """Update Excel report with counts and raw issue data"""
    filename = "sla_report.xlsx"
    counts_sheet = "SLA Report"
    raw_sheet = "Raw Issues"
    
    # Create new workbook if it doesn't exist
    if not os.path.exists(filename):
        wb = Workbook()
        wb.active.title = counts_sheet
        wb.create_sheet(raw_sheet)
        wb.save(filename)
    
    wb = load_workbook(filename)
    
    # === Update Counts Sheet ===
    if counts_sheet not in wb.sheetnames:
        ws_counts = wb.create_sheet(counts_sheet)
    else:
        ws_counts = wb[counts_sheet]
    
    header_row = 1
    max_col = ws_counts.max_column
    
    date_exists = False
    for col in range(1, max_col + 1):
        if ws_counts.cell(header_row, col).value == today_str:
            date_exists = True
            break
    
    if not date_exists:
        start_col = max_col + 1
        end_col = start_col + 1
        
        ws_counts.cell(header_row, start_col, today_str)
        ws_counts.merge_cells(start_row=header_row, start_column=start_col, end_row=header_row, end_column=end_col)
        
        ws_counts.cell(header_row + 1, start_col, "In Development")
        ws_counts.cell(header_row + 1, start_col + 1, "For Testing")
        
        header_fill = PatternFill(start_color="D9E1F2", end_color="D9E1F2", fill_type="solid")
        header_font = Font(bold=True)
        
        for r in range(header_row, header_row + 2):
            for c in range(start_col, end_col + 1):
                cell = ws_counts.cell(r, c)
                cell.alignment = Alignment(horizontal="center", vertical="center")
                cell.font = header_font
                if r == header_row:
                    cell.fill = header_fill
    
    projects = {}
    for row in range(3, ws_counts.max_row + 1):
        project_cell = ws_counts.cell(row, 1)
        if project_cell.value:
            project_key = project_cell.value.lower()
            if project_key in ["cmr", "dmr"]:
                projects[project_key] = row
    
    for project in ["cmr", "dmr"]:
        if project not in projects:
            new_row = ws_counts.max_row + 1
            ws_counts.cell(new_row, 1, project.upper())
            projects[project] = new_row
    
    for project, row_idx in projects.items():
        in_dev_count = counts[project]["In Development"]
        for_test_count = counts[project]["For Testing"]
        
        print(f"Writing for {project}: In Development={in_dev_count}, For Testing={for_test_count}")
        
        if not date_exists:
            ws_counts.cell(row_idx, start_col, in_dev_count if in_dev_count > 0 else "")
            ws_counts.cell(row_idx, start_col + 1, for_test_count if for_test_count > 0 else "")
        else:
            for col in range(1, ws_counts.max_column + 1):
                if ws_counts.cell(header_row, col).value == today_str:
                    ws_counts.cell(row_idx, col, in_dev_count if in_dev_count > 0 else "")
                    ws_counts.cell(row_idx, col + 1, for_test_count if for_test_count > 0 else "")
                    break
    
    total_row = None
    for row in range(3, ws_counts.max_row + 1):
        if ws_counts.cell(row, 1).value == "Total":
            total_row = row
            break
    
    if not total_row:
        total_row = ws_counts.max_row + 1
        ws_counts.cell(total_row, 1, "Total")
    
    for col in range(2, ws_counts.max_column + 1):
        if col == 2:
            continue
        col_sum = 0
        for row in range(3, total_row):
            value = ws_counts.cell(row, col).value
            if isinstance(value, (int, float)):
                col_sum += value
        ws_counts.cell(total_row, col, col_sum if col_sum > 0 else "")
    
    # === Update Raw Issues Sheet ===
    if raw_sheet not in wb.sheetnames:
        ws_raw = wb.create_sheet(raw_sheet)
    else:
        ws_raw = wb[raw_sheet]
    
    # Clear existing content in Raw Issues sheet
    ws_raw.delete_rows(1, ws_raw.max_row)
    
    # Add headers
    headers = ["Project", "Key", "Status"]
    ws_raw.append(headers)
    
    # Add raw issue data
    for issue in raw_issues:
        ws_raw.append([issue['project'], issue['key'], issue['status']])
    
    # Format headers
    header_fill = PatternFill(start_color="D9E1F2", end_color="D9E1F2", fill_type="solid")
    header_font = Font(bold=True)
    for cell in ws_raw[1]:
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = Alignment(horizontal="center", vertical="center")
    
    # Apply center alignment to all cells
    for row in ws_counts.iter_rows(min_row=1, max_row=ws_counts.max_row, min_col=1, max_col=ws_counts.max_column):
        for cell in row:
            cell.alignment = Alignment(horizontal="center", vertical="center")
    
    for row in ws_raw.iter_rows(min_row=1, max_row=ws_raw.max_row, min_col=1, max_col=ws_raw.max_column):
        for cell in row:
            cell.alignment = Alignment(horizontal="center", vertical="center")
    
    # Auto-adjust column widths for both sheets
    for ws in [ws_counts, ws_raw]:
        for col_idx in range(1, ws.max_column + 1):
            max_length = 0
            col_letter = get_column_letter(col_idx)
            for cell in ws[col_letter]:
                try:
                    if cell.value and len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = max_length + 2
            ws.column_dimensions[col_letter].width = adjusted_width
    
    wb.save(filename)
    print(f"\nReport updated: {filename}")

def main():
    print(f"Starting SLA report generation for {datetime.date.today().strftime('%d-%b-%Y')}")
    
    try:
        print("Preparing Jira API connection...")
        headers = get_jira_connection()
        print("Connection headers prepared successfully")
        
        cutoff_dates = calculate_cutoff_dates()
        
        jql = generate_jql(cutoff_dates)
        print("\nGenerated JQL:\n")
        print(jql)
        
        with open("sla_query.txt", "w") as f:
            f.write(jql)
        print("\nJQL saved to sla_query.txt")
        
        print("\nFetching issues from Jira...")
        issues = fetch_issues(headers, jql)
        print(f"Found {len(issues)} issues matching criteria")
        counts, raw_issues = process_issues(issues)
        
        today_str = datetime.date.today().strftime("%d-%b-%Y")
        update_excel_report(today_str, counts, raw_issues)
        
        print("\nReport generation completed successfully")
        
    except Exception as e:
        print(f"\nError occurred: {str(e)}")
        import traceback
        print(traceback.format_exc())

if __name__ == "__main__":
    main()